@page "/"
@using PremierInsight.Data
@using PremierInsight.Data.Models
@inject FplService FplService
@inject FootballDataService FootballDataService

<h1 class="text-center mt-4 text-primary">PremierInsight Dashboard</h1>

<!-- Navigation Tabs -->
<ul class="nav nav-tabs justify-content-center mt-4">
    <li class="nav-item">
        <a class="nav-link @(activeTab == "players" ? "active" : "")" href="#" @onclick='() => SetTab("players")'>Players</a>
    </li>
    <li class="nav-item">
        <a class="nav-link @(activeTab == "teams" ? "active" : "")" href="#" @onclick='() => SetTab("teams")'>League Table</a>
    </li>
    <li class="nav-item">
        <a class="nav-link @(activeTab == "fixtures" ? "active" : "")" href="#" @onclick='() => SetTab("fixtures")'>Fixtures</a>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content mt-4">

    @if (activeTab == "players")
    {
        <div>
            <h4 class="text-info mb-3">Fantasy Premier League Players</h4>

            @if (players == null)
            {
                <p>Loading player data...</p>
            }
            else
            {
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="topPlayersToggle" @bind="showTopPlayers" />
                    <label class="form-check-label" for="topPlayersToggle">
                        Show only Top 5 Players
                    </label>
                </div>

                <table class="table table-hover table-bordered table-dark">
                    <thead>
                        <tr>
                            <th>Player</th>
                            <th>Team ID</th>
                            <th>Position</th>
                            <th>Price (£m)</th>
                            <th>Total Points</th>
                            <th>Goals</th>
                            <th>Assists</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var p in GetFilteredPlayers())
                        {
                            <tr>
                                <td>@p.web_name</td>
                                <td>@p.team</td>
                                <td>@p.Position</td>
                                <td>@(p.now_cost / 10)</td>
                                <td>@p.total_points</td>
                                <td>@p.goals_scored</td>
                                <td>@p.assists</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
    }
    else if (activeTab == "teams")
    {
        <div>
            <h4 class="text-info mb-3">Premier League Table</h4>
            @if (teams == null)
            {
                <p>Loading league table...</p>
            }
            else
            {
                <table class="table table-striped table-dark">
                    <thead>
                        <tr>
                            <th>Pos</th>
                            <th>Team</th>
                            <th>Played</th>
                            <th>Points</th>
                            <th>GF</th>
                            <th>GA</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var t in teams)
                        {
                            <tr>
                                <td>@t.Position</td>
                                <td>@t.TeamName</td>
                                <td>@t.PlayedGames</td>
                                <td>@t.Points</td>
                                <td>@t.GoalsFor</td>
                                <td>@t.GoalsAgainst</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
    }
    else if (activeTab == "fixtures")
    {
        <div>
            <h4 class="text-info mb-3">Upcoming Fixtures</h4>
            @if (fixtures == null)
            {
                <p>Loading fixtures...</p>
            }
            else
            {
                <table class="table table-bordered table-hover table-dark">
                    <thead>
                        <tr>
                            <th>Matchday</th>
                            <th>Home Team</th>
                            <th>Away Team</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var f in fixtures)
                        {
                            <tr>
                                <td>@f.Matchday</td>
                                <td>@f.HomeTeam</td>
                                <td>@f.AwayTeam</td>
                                <td>@f.MatchDate.ToString("ddd, dd MMM yyyy HH:mm")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
    }
</div>

@code {
    private List<Player>? players;
    private List<TeamStanding>? teams;
    private List<Fixture>? fixtures;
    private string activeTab = "players";

    // Boolean for toggle switch
    private bool showTopPlayers = false;

    protected override async Task OnInitializedAsync()
    {
        var fplData = await FplService.GetFplDataAsync();
        players = fplData?.elements;

        teams = await FootballDataService.GetStandingsAsync();
        fixtures = await FootballDataService.GetUpcomingFixturesAsync();
    }

    private void SetTab(string tab)
    {
        activeTab = tab;
    }

    // Helper function for filtered player list
    private IEnumerable<Player> GetFilteredPlayers()
    {
        if (players == null)
            return Enumerable.Empty<Player>();

        var sorted = players.OrderByDescending(p => p.total_points);
        return showTopPlayers ? sorted.Take(5) : sorted.Take(15);
    }
}
